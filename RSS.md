

# On a Formal Model Safe and Scalable Self-driving Cars

##  1. 表征自动驾驶决策安全的现存方式

目前业界正在推广五种评估自动驾驶汽车安全性的方法：驾驶公里数、接管次数、仿真、基于场景的测试和专有方法。
“里程驱动”方法基于一个统计学论点，试图证明自动驾驶汽车在统计学上优于人类司机。这种方法是有问题的，因为要获得足够的统计证据来证明所声称的错误概率(即做出不安全驾驶决策的机会)已经满足，需要行驶的里程非常多。在下面的技术引理中，我们正式说明了为什么用统计方法来验证自动驾驶汽车系统是不可行的，即使是验证一个简单的说法，如“平均而言，系统每N小时发生一次事故”。
结论：假设人类每小时发生致命事故的可能性为 $10^{-6}$ ，那么AV-car需要至少三千万英里的数据来验证，如果想要比人更好，那么至少需要300亿英里的数据，且一旦系统中某个代码变更，严格来说又需要重新进行验证，这样做显然是不可行的。 另外测试的里程是否可靠有意义也值得怀疑。

## 2. The Responsibility-Sensitive Safety(RSS) model for Multi-agent Safety

总的来说，RSS是通过形式化以下5个“常识性”规则构建的:

1. 后车不会主动碰撞前车
2. cut-in不应该太过急切
3. 路权是赋予的，不是抢来的
4. 注意能见度有限的区域
5. 如果避免即将发生的事故且不会造成新的事故，那么必须这样做。

### 2.1. Gentle Start Single Lane Road

从一个最简单的假设场景出发：单车道的道路，汽车不能进行横向操作。这样做可以引入一些最简单的关键概念，比如安全距离，危险情况，正确的反应以及相应的责任。

​	在单车道上行驶，如果有车从后面装上你了，基本都是后车责任。但是也不是绝对，比如前车后车都在缓行，突然前车刹停并开始倒车，最终装上后车，那就是前车责任。在本节中，暂时不考虑前车出现倒车这种情况。这里我们更感兴趣的是后车怎样做确保不会与前车发生碰撞。通常，后车需要对前车保持一个安全距离。在我们简单的例子中，最坏的情况是前车突然猛刹车，后车需要一些时间来弄清楚这一点并刹车，然后两辆车都会减速直到完全停止。下面给出了这个概念的形式说明：

**定义一：(安全纵向距离)**

*一辆车跟在另一辆车后面，两辆车朝同一方向行驶，两者之间的纵向距离，是安全的，w.r.t.，如果反应时间为$\rho$,且$c_r$最大制动加速度为$a_{max,brake}$，在$c_r$在响应时间内加速，如果$c_r$将加速为最大$a_{max,acc}$，那么应该有个最小制动加速度$a_{min,brake}$,从制动到完全停止，那么它不会与$c_f$相撞。*

引理2通过前后车的速度来确定了相关的安全距离：

**Lemma2** 最小安全距离为：
$$
d_{min}=\left[
v_r \rho + \frac{1}{2}a_{max,accel}\rho^2 +
\frac{(v_r +\rho a_{max,accel})^2}{2a_{min,brake}}-
\frac{v_f^2}{2a_{max,brake}}
\right]
$$
**proof**

前车的制动距离加安全距离要大于后车反应时间内的移动距离加上后车的最大刹车距离
$$
d_0 + \frac{v_f^2}{2a_{max,brake}}-
\left(
v_r \rho + \frac{1}{2}a_{max,accel}\rho^2 +
\frac{v^2_{\rho,max}}{2a_{min,brake}}
\right)
$$
有：$v_{\rho,max} = v_r + \rho a_{max,accel}$ 

 现在回到最初的问题，如何确保不会被后车撞到。基本思路如下：当后车和前车的距离是不安全的，表示这种情况是不安全的，令$t_b$ 表示介于安全和危险之间的临界值。我们要求后车通过下列方式妥善的处理危险情况：在时间间隔$[t_b,t_b + \rho]$ 内，$c_r$ 可以应对任意加速度只要不超过$a_{max,accel}$. 之后，只要环境仍是危险的，$c_r$的制动加速度就至少为$a_{min,brake}$ .

**Remark** 

1. 安全纵向距离的定义和合适的相应取决于以下参数，$\rho,a_{max,accel},a_{min,brake},a_{max,brake}$ .这些参数引出了对道路主体行为的假设，例如，后车假设前车的刹车强度不会超过$a_{max,brake}$,即使前车的真实刹车强度超过了这个参数。如果前车的刹车强度超过了$a_{max,brake}$那么归纳证明就失效了，可能会发生事故。由于后车无法知道前车的确切制动机制，因此它无法知道的$a_{max,brake}$确切值。将它设置为一个非常大的值使模型更可靠，另一方面巨大的刹车值又会诱发一种极度的防御性驾驶，极端情况下，$a_{max,brake}=\infty$ ，从安全距离公式来看，前车就像是可以突然静止，显然不是一种正常的交通流。因此，我们认为这些参数应该通过监管确定为一些合理的值，因为它们引入了一组允许的假设，驾驶员(机器人或人类)可以对其他道路使用者的行为做出假设。当然，对于AV-car和人类驾驶的汽车，可以设置不同的参数。例如，机器人汽车的反应时间通常比人类司机的反应时间要短，而且AV-car的刹车比典型的人类司机更有效，因此对于AV-car $a_{min,brake}$可以设置更大一些。这些参数也可以根据不同的路况(潮湿的道路、结冰的道路、下雪的道路)进行不同的设置。
2. Utopia is possible.我们的归纳证明表明，如果一辆车对危险情况做出正确的反应，那么它就不会撞上后面的另一辆车，只要前车的刹车强度不超过$a_{max,brake}$，这立即意味着，如果所有的道路使用者都坚持假设，并对危险情况做出适当的反应，那么乌托邦是可能的，从某种意义上说，不会发生事故。这加强了我们定义的合理性。虽然这种说法对于我们现在考虑的简单情况来说是微不足道的，但我们稍后会证明，即使在考虑更复杂的世界(包括横向操纵、不同的几何形状、行人和闭塞)时，它也是成立的。

在描述了我们的技术背后的主要思想之后，我们现在转向更困难的部分，即为所有类型的道路构建适当的定义。我们从正式定义纵向和横向位置/速度/加速度的概念开始。

### 3.2 Preliminaries - A Lane-Based Coordinate System

本节的主要内容就是定义了一个沿着车道的坐标系，与Frenet坐标系基本一致。就不详细展开了。

### 3.3 Longitudinal Safe Distance and Proper Response

现在考虑两辆车相向而行，看看合适的刹车距离应该是多少？

**Definition 2 (Safe longitudinal distance -- opposite directions**

假设在一条车道上有两辆车c1,c2，纵向速度分别为$v_1,v_2$ ,且$v_1 > 0,v_2 < 0$ .有参数：反应时间$\rho$,刹车参数 $a_{min,brake},a_{min,brake,correct}$ 以及加速度参数 $a_{max,accel}$，在安全距离内，如果在反应时间内，c1,c2正在以最大加速度$a_{max,accel}$进行提速，并且之后以最大减速度$a_{min,brake,accel},a_{min,brake}$ 进行制动，也不会发生碰撞，安全距离的计算公式如下：
$$
d_{min} = \frac{v_1+v_{1,\rho}}{2}\rho + \frac{v^2_{1,\rho}}{2a_{min,brake,correct}}+\frac{|v_2|+v_{2,\rho}}{2}\rho + \frac{v^2_{2,\rho}}{2a_{min,brake}}
$$
其中 $v_{1,\rho} = v_1 + \rho a_{max,brake}$ ，$v_{2,\rho} = |v_2| + \rho a_{max,accel}$ 

在两辆车发生碰撞之前，它们首先需要保持一段非安全距离。直觉上，安全距离定义的概念是，如果两辆车都对违反安全距离做出“适当”的反应，那么就不会发生碰撞。如果其中一个没有做出“适当”的反应，那么它就应该对事故负责。为了使其形式化，首先要知道汽车开始处于非安全距离的时刻。

**Definition 3(Dangerous Longitudinal Situation and Danger Threshold)**

如果$c_1,c_2$在时刻t时是危险的，那么认为时刻t就是纵向危险的。给定一个纵向危险时刻t，它的纵向危险阈值表示为 $t^{long}_b$ ,是最早开始的纵向危险时间，在整个危险的时间域$[t^{long}_b,t]$​ 中。特别地，事故只能发生在时刻t如果它是纵向危险的，在这种情况下，我们说纵向事故的危险阈值为纵向阈值时间t。

接下来，我们定义什么是纵向危险情况下的“纵向适当响应”

**Definition 4(Longitudinal Proper response)**

令t为c1,c2的纵向危险时间，并且令$t^{long}_{b}$ 是相应的纵向责备时间(blame time)。两车的纵向固有响应应满足以下对纵向速度的约束:

1. 如果处于纵向危险阈值时间，两车处于驾驶在相同方向，且c1是后车，有：
   - 在时间间隔$[t^{long}_b,t^{long}_b +\rho] $ c1的加速度不能超过$a_{min,brake}$ ,并且在$t^{long}_b+\rho $之后加速度至少为$-a_{min,brake}$ 直到进入一个安全的纵向环境中。在那之后，任何非正加速度都是允许的
   - 在进入安全的纵向环境前，c2的加速度最多为$-a_{max,brake}$ ,在那之后，任何非负加速度都是允许的。
2. 如果处于纵向危险阈值时间，两车处于驾驶在相向方向，且c2为逆行
   - 在时间间隔$[t^{long}_b,t^{long}_b +\rho] $ c1的加速度不能超过$a_{max,accel}$,并且在$t^{long}_b+\rho $之后加速度至少为$-a_{min,brake,correct}$ 直到完全刹停。
   - c2的加速度在时间间隔$[t^{long}_b,t^{long}_b +\rho] $ 至少为$-a_{max,accel}$ ,并且在$t^{long}_b+\rho $之后加速度至少为$a_{min,brake}$ 直到完全刹停。

### 3.4 Lateral Safe Distance and Proper Response

与纵向速度不同，纵向速度可以长时间保持为0(汽车只是没有移动)，而横向速度完全保持为0是不可能的，因为汽车通常会进行小的横向波动。因此需要引入一个鲁棒的横向速度概念。

**Definition 5($\mu$ -lateral-velocity)**

考虑在时间t时，横向位置在$l$ 的一个点。那么在t时刻的$\mu$-lateral velocity定义如下：令$t_{out}>t$表示该点到达横向位置$l_{out}$的最早时间，$l_{out}$要么为$l-\mu/2$ 要么是$l+\mu/2$（如果该时间不存在，则$t_{out}=\infty$ .如果在时间间隔$t'\in (t,t_{out})$ ,该点的横向位置始终是$l$,那么横向速度就是0，否则为$(l_{out}-l) /(t_{out}-t)$ 

粗略地说，为了使两辆车发生碰撞，要求它们在纵向和横向上都很接近。对于纵轴，我们已经使用安全距离形式化了“接近”的概念。我们现在对横向距离做同样的计算:

**Definition 6(Safe Lateral Distance)**

关于参数$\rho,a^{lat}_{min,brake},a^{lat}_{max,accel},\mu$,如果在时间间隔$[0,\rho]$,两车朝着对车方向施加横向加速度$a^{lat}_{max,accel}$，接着施加横向制动$a^{lat}_{min,brake}$ 直到到达0横向速度，接着最终的横向距离至少为$\mu$,那么可以认为$c_1$与$c_2$的横向安全距离在速度为$v_1,v_2$下是安全的。

横向距离计算方式如下：

**Lemma 4**
$$
d_{min} = \mu + \left[
\frac{v_1+v_{1,\rho}}{2}\rho +
\frac{v^2_{1,\rho}}{2a^{lat}_{min,brake}}-
\left(
\frac{v_2+v_{2,\rho}}{2}\rho - \frac{v^2_{2,rho}}{2a^{lat}_{min,brake}}
\right)
\right]
$$
其中，$v_{1,\rho}=v_1+\rho a^{lat}_{max,accel}$ ,$v_{2,\rho}=v_2-\rho a^{lat}_{max,accel}$ 

**Definition 7(Dangerous Lateral Situation and Danger Threshold time)**

与定义3类似，只是变成了横向

**Definition 8(Lateral Proper response)**

假设t是横向危险时刻，且$t^{lat}_{b}$ 是相应的横向危险阈值时间，同时$c_1$在$c_2$的左侧，两车的横向固有响应应满足以下对横向速度的约束:

- 如果$t\in [t^{lat}_b,t^{lat}_b+\rho]$ ，两车可以做任何行为，只要他们的横向加速度a,满足$|a|\leq a^{lat}_{max,accel}$ 
- 否则如果 $t \geq t^{lat}_b + \rho$ ：
  - 当达到$\mu$-lateral-velocity of 0之前，$c_1$必须施加横向加速度至多为$-a^{lat}_{min,brake}$，$c_2$必须施加至少为$a^{lat}_{brake}$ 的横向加速度。
  -  在达到$\mu$-lateral-velocity of 0之后，$c_1$可以施加任意非正的$\mu$-lateral-velocity，$c_2$可以施加任意非负的$\mu$-lateral-velocity

**Remark 4** 

为简单起见，我们假设汽车可以立即从“横向制动($a^{lat}_{min,brake}$)”切换到$\mu$-lateral-velocity of 0,由于汽车的物理特性，这可能并不总是可能的，但是，定义正确响应的重要原因是，从时间$t_b+\rho$ 到汽车达到µ-横向速度0，它将通过的总横向距离不会大于如果它施加$a_lat$的制动直到完全停止时它将经过的距离。在真正的车辆上实现这一目标是可能的，首先以更大的速度刹车，然后在最后逐渐降低横向速度。很容易看出，这种变化不会对RSS的本质产生影响(也不会对有效保证RSS安全性的过程产生影响，这将在下一节中描述)。

**Remark 5**

通过对每辆车的所有点取最坏情况，该定义适用于任意形状的车辆。这尤其适用于半挂车或门打开的汽车

### 3.5 Combining Longitudinal and Lateral Proper Response

 接下来，我们将纵向和横向的固有响应组合成一个单一的固有响应。我们以多车道道路(典型的高速公路或乡村道路)为例，其中所有车道共享相同的几何形状。在这种情况下，我们可以把所有车道都称为一个宽车道，纵向和横向位置的含义是很好的定义。多重几何形状(合并、交叉路口、环形交叉路口等)和非结构化道路的情况将在下一小节中讨论，我们将在下一小节中介绍优先级的概念。

为了使两辆车发生碰撞，它们必须同时处于非安全的纵向距离和非安全的横向距离。

**Definition 9(Dangerous Situation and Danger Threshold time) **

如果横向和纵向上都是危险的，那么我们就说t时刻对于$c_1,c_2$都是危险的。给定一个危险的时刻t，它的危险阈值时间，表示为$t_b = max(t^{long}_{b},t^{lat}_b)$ ，$t^{long}_{b},t^{lat}_b$分别是横向和纵向危险阈值时间。特别地，如果事故是危险的，事故只能在时间t发生，在这种情况下，我们说事故的危险阈值时间是t。

当两辆车并排行驶时，它们已经处于不安全的纵向距离，如果情况变得危险，这意味着他们在侧面越来越近，侧面的情况也变得危险，这就是$t_b = t^{lat}_b$.在这种情况下，正确的反应是对横向危险情况采取正确的反应，这是有道理的。同样，如果一辆车在另一辆车后面行驶，它们已经处于非安全的横向距离。如果情况变得危险，这意味着他们越来越接近纵向，纵向的情况也变得危险。这就是$t_b = t^{long}_b$,在这种情况下，适当的反应是针对纵向危险情况应用适当的反应，这是有道理的。下面的定义捕捉到了这一点。

**Definition 10(Basic Proper response to dangerous situations)** 

对于$c_1,c_2$令t时刻是危险时刻，并且令$t_b,t^{long}_b,t^{lat}_b$ 是相应的危险阈值时间，纵向危险阈值时间，横向危险阈值时间。这两辆车的基本正常响应是在横向/纵向速度上遵守以下约束:

1. 如果$t=t^{long}_b$,那么纵向速度由定义4进行约束
2. 如果$t=t^{lat}_b$,那么横向速度有定义8进行约束

下图可以证明：

![RSS_figure3](E:\PnC\pnc_research\RSS_figure3.png)

Figure3: 每辆车周围的竖线显示了汽车可能的横向位置，如果它在响应时间内横向加速，然后横向刹车,同样，矩形显示了汽车可能的纵向位置。在前两排，在危险阈值时间之前存在安全的横向距离，因此正确的反应是横向制动。黄色汽车的横向速度已经为零，因此只有红色汽车横向刹车。第三行:在危险阈值时间之前有一个安全的纵向距离，因此正确的反应是后车纵向制动。第四行:在危险阈值时间之前存在一个安全的纵向距离，在迎面情况下，因此两车应纵向制动。

为了加强上述定义的合理性，下面的引理表明，如果所有的汽车都能正确反应，那么就不会发生事故。

**Lemma 5**

考虑一条多车道道路，其中所有车道共享相同的几何形状，假设在任何时候，道路上的所有车辆都符合定义10中给出的基本适当响应。这样就不会发生碰撞。

### 3.6 Compensating for improper behavior of others

 在前一小节中，我们已经证明，如果所有的汽车都能正确响应，根据基本正确响应的定义，那么就不会发生碰撞。但是，可能是某些agent没有正确响应，而另一个agent可以防止事故发生。在这种情况下，要求agent尽“最大努力”以避免危险情况是合理的。另一方面，我们不希望试图避免一个事故会导致另一个事故，我们也不希望避免所有事故的要求会严重损害模型的有用性(例如，如果暗示总是处于极低的速度)。

我们通过引入另一层保护来解决这个折衷问题，如下所示。假设我们已经处于另一个主体的危险状态我们知道如果另一个主体保持其当前行为而我们继续施加适当的响应，就会发生碰撞。例如考虑figure3最上面一个图，我们是黄色车辆，最基础的反应就是不向红色车辆做横向移动，红车正确的反应就是停止朝着这里做横向移动。假设红色汽车不停止它的横向移动。为了避免碰撞，我们可以纵向刹车或向左横向移动(或两者都可以)。假设红色汽车保持目前的行为，任何不会发生碰撞的动作都是一种很好的规避动作。此外，即使不会发生碰撞，我们也不希望长时间处于危险的境地。因此，我们应该计划一个行动，将我们带回到一个非危险的情况。

为了使其形式化，我们需要一些额外的定义。

**Definition 11(Naive Prediction)**

道路主体的纵向或横向状态由其位置、速度和加速度定义，用$p_0,v_0,a_0$表示。假设一个朴素的预测，未来的状态如下：令$\tau = -v_0/a_0$，在$v_0,a_0$是反向的情况下，否则$\tau = \infty$.如果$t\in[0,\tau]$,加速度为$a_0$,否则加速度为0。t时刻的速度是$v_0$ 加上加速度的积分，位置是$p_0$加上速度的积分,

**Definition 12(Evasive Manoeuvre)**

假设在$t_0$时刻，对于$c_1,c_2$来说当前情景时危险的。关于规划时间T，对于$c_1$一个规避的操作是设置两个函数:$m^{long}:[t_0,t_1] \rightarrow \mathbb{R}}$   
