

# On a Formal Model Safe and Scalable Self-driving Cars

[TOC]

##  1. 表征自动驾驶决策安全的现存方式

目前业界正在推广五种评估自动驾驶汽车安全性的方法：驾驶公里数、接管次数、仿真、基于场景的测试和专有方法。
“里程驱动”方法基于一个统计学论点，试图证明自动驾驶汽车在统计学上优于人类司机。这种方法是有问题的，因为要获得足够的统计证据来证明所声称的错误概率(即做出不安全驾驶决策的机会)已经满足，需要行驶的里程非常多。在下面的技术引理中，我们正式说明了为什么用统计方法来验证自动驾驶汽车系统是不可行的，即使是验证一个简单的说法，如“平均而言，系统每N小时发生一次事故”。
结论：假设人类每小时发生致命事故的可能性为 $10^{-6}$ ，那么AV-car需要至少三千万英里的数据来验证，如果想要比人更好，那么至少需要300亿英里的数据，且一旦系统中某个代码变更，严格来说又需要重新进行验证，这样做显然是不可行的。 另外测试的里程是否可靠有意义也值得怀疑。

## 2. The Responsibility-Sensitive Safety(RSS) model for Multi-agent Safety

总的来说，RSS是通过形式化以下5个“常识性”规则构建的:

1. 后车不会主动碰撞前车
2. cut-in不应该太过急切
3. 路权是赋予的，不是抢来的
4. 注意能见度有限的区域
5. 如果避免即将发生的事故且不会造成新的事故，那么必须这样做。

### 2.1. Gentle Start Single Lane Road

从一个最简单的假设场景出发：单车道的道路，汽车不能进行横向操作。这样做可以引入一些最简单的关键概念，比如安全距离，危险情况，正确的反应以及相应的责任。

​	在单车道上行驶，如果有车从后面装上你了，基本都是后车责任。但是也不是绝对，比如前车后车都在缓行，突然前车刹停并开始倒车，最终装上后车，那就是前车责任。在本节中，暂时不考虑前车出现倒车这种情况。这里我们更感兴趣的是后车怎样做确保不会与前车发生碰撞。通常，后车需要对前车保持一个安全距离。在我们简单的例子中，最坏的情况是前车突然猛刹车，后车需要一些时间来弄清楚这一点并刹车，然后两辆车都会减速直到完全停止。下面给出了这个概念的形式说明：

**定义一：(安全纵向距离)**

*一辆车跟在另一辆车后面，两辆车朝同一方向行驶，两者之间的纵向距离，是安全的，w.r.t.，如果反应时间为$\rho$,且$c_r$最大制动加速度为$a_{max,brake}$，在$c_r$在响应时间内加速，如果$c_r$将加速为最大$a_{max,acc}$，那么应该有个最小制动加速度$a_{min,brake}$,从制动到完全停止，那么它不会与$c_f$相撞。*

引理2通过前后车的速度来确定了相关的安全距离：

**Lemma2** 最小安全距离为：
$$
d_{min}=\left[
v_r \rho + \frac{1}{2}a_{max,accel}\rho^2 +
\frac{(v_r +\rho a_{max,accel})^2}{2a_{min,brake}}-
\frac{v_f^2}{2a_{max,brake}}
\right]
$$
**proof**

前车的制动距离加安全距离要大于后车反应时间内的移动距离加上后车的最大刹车距离
$$
d_0 + \frac{v_f^2}{2a_{max,brake}}-
\left(
v_r \rho + \frac{1}{2}a_{max,accel}\rho^2 +
\frac{v^2_{\rho,max}}{2a_{min,brake}}
\right)
$$
有：$v_{\rho,max} = v_r + \rho a_{max,accel}$ 

 现在回到最初的问题，如何确保不会被后车撞到。基本思路如下：当后车和前车的距离是不安全的，表示这种情况是不安全的，令$t_b$ 表示介于安全和危险之间的临界值。我们要求后车通过下列方式妥善的处理危险情况：在时间间隔$[t_b,t_b + \rho]$ 内，$c_r$ 可以应对任意加速度只要不超过$a_{max,accel}$. 之后，只要环境仍是危险的，$c_r$的制动加速度就至少为$a_{min,brake}$ .

**Remark** 

1. 安全纵向距离的定义和合适的相应取决于以下参数，$\rho,a_{max,accel},a_{min,brake},a_{max,brake}$ .这些参数引出了对道路主体行为的假设，例如，后车假设前车的刹车强度不会超过$a_{max,brake}$,即使前车的真实刹车强度超过了这个参数。如果前车的刹车强度超过了$a_{max,brake}$那么归纳证明就失效了，可能会发生事故。由于后车无法知道前车的确切制动机制，因此它无法知道的$a_{max,brake}$确切值。将它设置为一个非常大的值使模型更可靠，另一方面巨大的刹车值又会诱发一种极度的防御性驾驶，极端情况下，$a_{max,brake}=\infty$ ，从安全距离公式来看，前车就像是可以突然静止，显然不是一种正常的交通流。因此，我们认为这些参数应该通过监管确定为一些合理的值，因为它们引入了一组允许的假设，驾驶员(机器人或人类)可以对其他道路使用者的行为做出假设。当然，对于AV-car和人类驾驶的汽车，可以设置不同的参数。例如，机器人汽车的反应时间通常比人类司机的反应时间要短，而且AV-car的刹车比典型的人类司机更有效，因此对于AV-car $a_{min,brake}$可以设置更大一些。这些参数也可以根据不同的路况(潮湿的道路、结冰的道路、下雪的道路)进行不同的设置。
2. Utopia is possible.我们的归纳证明表明，如果一辆车对危险情况做出正确的反应，那么它就不会撞上后面的另一辆车，只要前车的刹车强度不超过$a_{max,brake}$，这立即意味着，如果所有的道路使用者都坚持假设，并对危险情况做出适当的反应，那么乌托邦是可能的，从某种意义上说，不会发生事故。这加强了我们定义的合理性。虽然这种说法对于我们现在考虑的简单情况来说是微不足道的，但我们稍后会证明，即使在考虑更复杂的世界(包括横向操纵、不同的几何形状、行人和闭塞)时，它也是成立的。

在描述了我们的技术背后的主要思想之后，我们现在转向更困难的部分，即为所有类型的道路构建适当的定义。我们从正式定义纵向和横向位置/速度/加速度的概念开始。

## 3. The Responsibility-Sensitive Safety (RSS) model for Multi-agent Safety  

### 3.2 Preliminaries - A Lane-Based Coordinate System

本节的主要内容就是定义了一个沿着车道的坐标系，与Frenet坐标系基本一致。就不详细展开了。

### 3.3 Longitudinal Safe Distance and Proper Response

现在考虑两辆车相向而行，看看合适的刹车距离应该是多少？

**Definition 2 (Safe longitudinal distance -- opposite directions**

假设在一条车道上有两辆车c1,c2，纵向速度分别为$v_1,v_2$ ,且$v_1 > 0,v_2 < 0$ .有参数：反应时间$\rho$,刹车参数 $a_{min,brake},a_{min,brake,correct}$ 以及加速度参数 $a_{max,accel}$，在安全距离内，如果在反应时间内，c1,c2正在以最大加速度$a_{max,accel}$进行提速，并且之后以最大减速度$a_{min,brake,accel},a_{min,brake}$ 进行制动，也不会发生碰撞，安全距离的计算公式如下：
$$
d_{min} = \frac{v_1+v_{1,\rho}}{2}\rho + \frac{v^2_{1,\rho}}{2a_{min,brake,correct}}+\frac{|v_2|+v_{2,\rho}}{2}\rho + \frac{v^2_{2,\rho}}{2a_{min,brake}}
$$
其中 $v_{1,\rho} = v_1 + \rho a_{max,brake}$ ，$v_{2,\rho} = |v_2| + \rho a_{max,accel}$ 

在两辆车发生碰撞之前，它们首先需要保持一段非安全距离。直觉上，安全距离定义的概念是，如果两辆车都对违反安全距离做出“适当”的反应，那么就不会发生碰撞。如果其中一个没有做出“适当”的反应，那么它就应该对事故负责。为了使其形式化，首先要知道汽车开始处于非安全距离的时刻。

**Definition 3(Dangerous Longitudinal Situation and Danger Threshold)**

如果$c_1,c_2$在时刻t时是危险的，那么认为时刻t就是纵向危险的。给定一个纵向危险时刻t，它的纵向危险阈值表示为 $t^{long}_b$ ,是最早开始的纵向危险时间，在整个危险的时间域$[t^{long}_b,t]$​ 中。特别地，事故只能发生在时刻t如果它是纵向危险的，在这种情况下，我们说纵向事故的危险阈值为纵向阈值时间t。

接下来，我们定义什么是纵向危险情况下的“纵向适当响应”

**Definition 4(Longitudinal Proper response)**

令t为c1,c2的纵向危险时间，并且令$t^{long}_{b}$ 是相应的纵向责备时间(blame time)。两车的纵向固有响应应满足以下对纵向速度的约束:

1. 如果处于纵向危险阈值时间，两车处于驾驶在相同方向，且c1是后车，有：
   - 在时间间隔$[t^{long}_b,t^{long}_b +\rho] $ c1的加速度不能超过$a_{min,brake}$ ,并且在$t^{long}_b+\rho $之后加速度至少为$-a_{min,brake}$ 直到进入一个安全的纵向环境中。在那之后，任何非正加速度都是允许的
   - 在进入安全的纵向环境前，c2的加速度最多为$-a_{max,brake}$ ,在那之后，任何非负加速度都是允许的。
2. 如果处于纵向危险阈值时间，两车处于驾驶在相向方向，且c2为逆行
   - 在时间间隔$[t^{long}_b,t^{long}_b +\rho] $ c1的加速度不能超过$a_{max,accel}$,并且在$t^{long}_b+\rho $之后加速度至少为$-a_{min,brake,correct}$ 直到完全刹停。
   - c2的加速度在时间间隔$[t^{long}_b,t^{long}_b +\rho] $ 至少为$-a_{max,accel}$ ,并且在$t^{long}_b+\rho $之后加速度至少为$a_{min,brake}$ 直到完全刹停。

### 3.4 Lateral Safe Distance and Proper Response

与纵向速度不同，纵向速度可以长时间保持为0(汽车只是没有移动)，而横向速度完全保持为0是不可能的，因为汽车通常会进行小的横向波动。因此需要引入一个鲁棒的横向速度概念。

**Definition 5($\mu$ -lateral-velocity)**

考虑在时间t时，横向位置在$l$ 的一个点。那么在t时刻的$\mu$-lateral velocity定义如下：令$t_{out}>t$表示该点到达横向位置$l_{out}$的最早时间，$l_{out}$要么为$l-\mu/2$ 要么是$l+\mu/2$（如果该时间不存在，则$t_{out}=\infty$ .如果在时间间隔$t'\in (t,t_{out})$ ,该点的横向位置始终是$l$,那么横向速度就是0，否则为$(l_{out}-l) /(t_{out}-t)$ 

粗略地说，为了使两辆车发生碰撞，要求它们在纵向和横向上都很接近。对于纵轴，我们已经使用安全距离形式化了“接近”的概念。我们现在对横向距离做同样的计算:

**Definition 6(Safe Lateral Distance)**

关于参数$\rho,a^{lat}_{min,brake},a^{lat}_{max,accel},\mu$,如果在时间间隔$[0,\rho]$,两车朝着对车方向施加横向加速度$a^{lat}_{max,accel}$，接着施加横向制动$a^{lat}_{min,brake}$ 直到到达0横向速度，接着最终的横向距离至少为$\mu$,那么可以认为$c_1$与$c_2$的横向安全距离在速度为$v_1,v_2$下是安全的。

横向距离计算方式如下：

**Lemma 4**
$$
d_{min} = \mu + \left[
\frac{v_1+v_{1,\rho}}{2}\rho +
\frac{v^2_{1,\rho}}{2a^{lat}_{min,brake}}-
\left(
\frac{v_2+v_{2,\rho}}{2}\rho - \frac{v^2_{2,rho}}{2a^{lat}_{min,brake}}
\right)
\right]
$$
其中，$v_{1,\rho}=v_1+\rho a^{lat}_{max,accel}$ ,$v_{2,\rho}=v_2-\rho a^{lat}_{max,accel}$ 

**Definition 7(Dangerous Lateral Situation and Danger Threshold time)**

与定义3类似，只是变成了横向

**Definition 8(Lateral Proper response)**

假设t是横向危险时刻，且$t^{lat}_{b}$ 是相应的横向危险阈值时间，同时$c_1$在$c_2$的左侧，两车的横向固有响应应满足以下对横向速度的约束:

- 如果$t\in [t^{lat}_b,t^{lat}_b+\rho]$ ，两车可以做任何行为，只要他们的横向加速度a,满足$|a|\leq a^{lat}_{max,accel}$ 
- 否则如果 $t \geq t^{lat}_b + \rho$ ：
  - 当达到$\mu$-lateral-velocity of 0之前，$c_1$必须施加横向加速度至多为$-a^{lat}_{min,brake}$，$c_2$必须施加至少为$a^{lat}_{brake}$ 的横向加速度。
  -  在达到$\mu$-lateral-velocity of 0之后，$c_1$可以施加任意非正的$\mu$-lateral-velocity，$c_2$可以施加任意非负的$\mu$-lateral-velocity

**Remark 4** 

为简单起见，我们假设汽车可以立即从“横向制动($a^{lat}_{min,brake}$)”切换到$\mu$-lateral-velocity of 0,由于汽车的物理特性，这可能并不总是可能的，但是，定义正确响应的重要原因是，从时间$t_b+\rho$ 到汽车达到µ-横向速度0，它将通过的总横向距离不会大于如果它施加$a_lat$的制动直到完全停止时它将经过的距离。在真正的车辆上实现这一目标是可能的，首先以更大的速度刹车，然后在最后逐渐降低横向速度。很容易看出，这种变化不会对RSS的本质产生影响(也不会对有效保证RSS安全性的过程产生影响，这将在下一节中描述)。

**Remark 5**

通过对每辆车的所有点取最坏情况，该定义适用于任意形状的车辆。这尤其适用于半挂车或门打开的汽车

### 3.5 Combining Longitudinal and Lateral Proper Response

 接下来，我们将纵向和横向的固有响应组合成一个单一的固有响应。我们以多车道道路(典型的高速公路或乡村道路)为例，其中所有车道共享相同的几何形状。在这种情况下，我们可以把所有车道都称为一个宽车道，纵向和横向位置的含义是很好的定义。多重几何形状(合并、交叉路口、环形交叉路口等)和非结构化道路的情况将在下一小节中讨论，我们将在下一小节中介绍优先级的概念。

为了使两辆车发生碰撞，它们必须同时处于非安全的纵向距离和非安全的横向距离。

**Definition 9(Dangerous Situation and Danger Threshold time) **

如果横向和纵向上都是危险的，那么我们就说t时刻对于$c_1,c_2$都是危险的。给定一个危险的时刻t，它的危险阈值时间，表示为$t_b = max(t^{long}_{b},t^{lat}_b)$ ，$t^{long}_{b},t^{lat}_b$分别是横向和纵向危险阈值时间。特别地，如果事故是危险的，事故只能在时间t发生，在这种情况下，我们说事故的危险阈值时间是t。

当两辆车并排行驶时，它们已经处于不安全的纵向距离，如果情况变得危险，这意味着他们在侧面越来越近，侧面的情况也变得危险，这就是$t_b = t^{lat}_b$.在这种情况下，正确的反应是对横向危险情况采取正确的反应，这是有道理的。同样，如果一辆车在另一辆车后面行驶，它们已经处于非安全的横向距离。如果情况变得危险，这意味着他们越来越接近纵向，纵向的情况也变得危险。这就是$t_b = t^{long}_b$,在这种情况下，适当的反应是针对纵向危险情况应用适当的反应，这是有道理的。下面的定义捕捉到了这一点。

**Definition 10(Basic Proper response to dangerous situations)** 

对于$c_1,c_2$令t时刻是危险时刻，并且令$t_b,t^{long}_b,t^{lat}_b$ 是相应的危险阈值时间，纵向危险阈值时间，横向危险阈值时间。这两辆车的基本正常响应是在横向/纵向速度上遵守以下约束:

1. 如果$t=t^{long}_b$,那么纵向速度由定义4进行约束
2. 如果$t=t^{lat}_b$,那么横向速度有定义8进行约束

下图可以证明：

![RSS_figure3](E:\PnC\pnc_research\elements\RSS_figure3.png)

Figure3: 每辆车周围的竖线显示了汽车可能的横向位置，如果它在响应时间内横向加速，然后横向刹车,同样，矩形显示了汽车可能的纵向位置。在前两排，在危险阈值时间之前存在安全的横向距离，因此正确的反应是横向制动。黄色汽车的横向速度已经为零，因此只有红色汽车横向刹车。第三行:在危险阈值时间之前有一个安全的纵向距离，因此正确的反应是后车纵向制动。第四行:在危险阈值时间之前存在一个安全的纵向距离，在迎面情况下，因此两车应纵向制动。

为了加强上述定义的合理性，下面的引理表明，如果所有的汽车都能正确反应，那么就不会发生事故。

**Lemma 5**

考虑一条多车道道路，其中所有车道共享相同的几何形状，假设在任何时候，道路上的所有车辆都符合定义10中给出的基本适当响应。这样就不会发生碰撞。

### 3.6 Compensating for improper behavior of others

 在前一小节中，我们已经证明，如果所有的汽车都能正确响应，根据基本正确响应的定义，那么就不会发生碰撞。但是，可能是某些agent没有正确响应，而另一个agent可以防止事故发生。在这种情况下，要求agent尽“最大努力”以避免危险情况是合理的。另一方面，我们不希望试图避免一个事故会导致另一个事故，我们也不希望避免所有事故的要求会严重损害模型的有用性(例如，如果暗示总是处于极低的速度)。

我们通过引入另一层保护来解决这个折衷问题，如下所示。假设我们已经处于另一个主体的危险状态我们知道如果另一个主体保持其当前行为而我们继续施加适当的响应，就会发生碰撞。例如考虑figure3最上面一个图，我们是黄色车辆，最基础的反应就是不向红色车辆做横向移动，红车正确的反应就是停止朝着这里做横向移动。假设红色汽车不停止它的横向移动。为了避免碰撞，我们可以纵向刹车或向左横向移动(或两者都可以)。假设红色汽车保持目前的行为，任何不会发生碰撞的动作都是一种很好的规避动作。此外，即使不会发生碰撞，我们也不希望长时间处于危险的境地。因此，我们应该计划一个行动，将我们带回到一个非危险的情况。

为了使其形式化，我们需要一些额外的定义。

**Definition 11(Naive Prediction)**

道路主体的纵向或横向状态由其位置、速度和加速度定义，用$p_0,v_0,a_0$表示。假设一个朴素的预测，未来的状态如下：令$\tau = -v_0/a_0$，在$v_0,a_0$是反向的情况下，否则$\tau = \infty$.如果$t\in[0,\tau]$,加速度为$a_0$,否则加速度为0。t时刻的速度是$v_0$ 加上加速度的积分，位置是$p_0$加上速度的积分,

**Definition 12(Evasive Manoeuvre)**

假设在$t_0$时刻，对于$c_1,c_2$来说当前情景时危险的。关于规划时间T，对于$c_1$一个规避的操作是设置两个函数:$m^{long}:[t_0,t_1] \rightarrow \mathbb{R}$  以及$m^{lat} : [t_0,t_1] \rightarrow \mathbb{R}$ ,其中$t_1 = t_0 + T$

- 对于 $t \in [t_0,t_1]$,$c_1$的纵向和横向位置由$m^{long}(t)$和$m^{lat}(t)$给定。作为结果，横向和纵向的速度以及加速度就是上面的一阶导数和二阶导数。
- 假设在整个时间间隔$[t_0,t_1]$内，$c_2$的驾驶行为是由naive prediction给出(见定义11)，而$c_1$驾驶行为根据$m^{long}(t),m^{lat}(t)$给出，这样两车就不会在时间$[t_0,t_1]$内发生碰撞，且$t_1$也不再是危险时间。

我们认为规避行为是合法的，除上述条件外，还应满足以下条件:

- 相对于所有其他agent，$c_1$在时刻$t_0$的纵向和横向加速度满足基本的合适的响应约束(如定义10所示)。
- 横向加速度的绝对值，根据函数$m^{lat}$,总是不超过$a^{lat}_{max,accel}$，并且纵向加速度根据 $m^{long}$总是处于区间$[-a_{max,brake},a_{max,accel}]$

现在我们将定义10扩展为包括常识性规则“如果你能避免一个事故而不引起另一个事故，你必须这样做”。

**Definition 13(Proper Response with Extra Evasive Effort)**

对于$c_1,c_2$,t为危险时间，并且令$t_b$为相应的blame time.假设在区间$[t_b,t]$,车$c_2$不遵循定义10中给出的适当响应约束，假设对于$c_1$同样存在一个合法的规避操作，如定义12中一样。那么，c1的正确反应是运用合法的规避操作(除了定义10中给出的适当响应约束之外)。

通过要求规避动作绝不能与定义10相抵触，我们确保它们不会再造成事故。显然，引理5的证明仍然成立，即使汽车应用定义13中的适当响应。

### 3.7 Multiple Geometry and Right of Way Rules

接下来，我们将处理在一个场景中有多个不同的道路几何形状在某个区域重叠的场景。例如环岛、交叉路口和汇入高速公路。如图4所示，在许多这样的情况下，一条路线优先于其他路线，行驶在这条路线上的车辆有通行权。

![RSS_figure4](E:\PnC\pnc_research\elements\RSS_figure4.png)

在前面的小节中，我们可以假设路线是直的，依靠第3.2节，该节展示了如何在一般车道几何形状和直线道路之间构建双射，并在纵向和横向轴上具有一致的含义。当面对多种路由几何的场景时，需要对定义进行调整。首先，不同几何形状的两条路径在适当响应的约束条件下会产生冲突。图5给出了一个示例。

![RSS_figure5](E:\PnC\pnc_research\elements\RSS_figure5.png)

图5:由于多个几何形状导致的适当响应冲突。右图:如果所有的路线共享相同的几何形状，那么对于不同的车辆，适当的响应约束之间就不会有冲突。左:蓝色车相对于黄色车和黄色路线的适当反应是沿着黄色路线继续直线行驶，而蓝色车相对于红色车和红色路线的适当反应是沿着红色路线的中心继续行驶。这两个约束相互矛盾。

此外，考虑图4b所示的t形路口，并假设红色路线有一个停车标志。假设c1接近黄色路线上的十字路口同时c2接近红色路线上的十字路口。根据黄色路线的坐标系，c2具有非常大的横向速度，因此c1可以推断出c2已经处于非安全横向距离，这意味着c1在优先路线上行驶时必须减速以保持与c2的安全纵向距离。这意味着c2对于来自红色路线的流量应该是非常保守的。这当然是一种不自然的行为，因为在这种情况下，黄色路线上的汽车有优先通行权.此外，只要c1能够及时停车，即使是没有优先级的c2也应该能够汇入路口(这在密集的交通中是至关重要的)。这个例子表明，当c1驾驶在r1上时，考虑它在r2上的坐标系是没有意义的。因此，我们需要推广前面小节中的基本概念，例如“c1在c2前面是什么意思”，以及处于非安全距离是什么意思。

**Remark 6**

*下面的定义假设有两辆车，c1,c2在不同的路线r1,r2上行驶。我们强调，在某些情况下(例如，图4b所示的t形路口)，一旦只有一条路线r1，两辆车都被分配到这条路线上，并且时间不危险，那么从那一刻起，定义就完全是关于r1的。*

首先概括了安全侧向距离和侧向固有响应的定义。不难验证，将下面的定义应用于相同几何形状的两条路线确实会得到与定义6相同的定义。在本节中，我们有时将路径称为R2的子集。

**Definition 14（Lateral Safe Distance for Two Routes of Diffierent Geometry)**

*考虑c1,c2分别驾驶在r1,r2上，并差不多时间到达交汇路口。对于每一个$i\in {1,2}$ ,令$[x_{i,min},x_{i,max}]$ 为$r_i$上最小或者最大的横向位置。如果在时间区间$[0,\rho]$内，将会施加一个横向的加速度(关于$r_i$),约束在$|a^{lat} \leq a^{lat}_{max,accel}$，并且接着，施加一个横向的制动加速度至少为$a^{lat}_{min,brake}$ (关于$r_i$),直到达到0横向速度。如果r1, r2对横向区间$[x_{1,min},x_{1,max}],[x_{1,min},x_{1,max}]$的限制距离至少为µ,那么c1,c2之间的横向距离就是安全的.*

侧边危险时间和危险阈值时间的定义同定义7，但侧边安全距离参照定义14。接下来我们定义横向固有反应。

**Definition 15(Lateral Proper response for Two Routes of Diffierent Geometry)**

令$t^{lat}_b$为横向危险阈值时间，$x_1,x_2$为在时间$t^{lat}_b$时，c1,c2分别在r1,r2上相应的横向位置。两车的横向固有响应应满足以下对横向速度的约束:

- 如果$t \in [t^{lat}_b,t^{lat}_b+\rho]$ ,只要横向加速度满足约束$|a| \leq a^{lat}_{max,accel}$ 那么两车可以做任意的横向动作。
- 否则如果：$t \geq t^{lat}_b+\rho$,对每个$i \in {1,2}$
  - 在达到$\mu$横向速度为0之前，$c_i$必须朝着$x_i$施加横向加速度且值至少为$|a^{lat}_{min,brake}|$
  - 在达到$\mu$横向速度为0之后，$c_i$可以做任何横向加速度，使它远离另一辆车

在定义纵向安全距离之前，我们需要在不存在公共纵轴的情况下，量化车与车之间的排序。

**Definition 16(Longitudinal Ordering for Two Routes of Different Geometry)**

考虑$c_1,c_2$驾驶在r1,r2上并将要达到交叉路口，我们认为$c_1$在纵向上是在$c_2$前面，只要任意以下一条满足：

1. 对于每一个$i$，如果两车都在$r_i$上，那么根据$r_i$,$c_1$是在$c_2$的前面
2. 如果$c_1$不在$r_2$上，$c_2$不在$r_1$上，如果$c_1$到交汇路口的距离比$c_2$要短，那么认为$c_1$在前方。

![RSS_figure6](E:\PnC\pnc_research\elements\RSS_figure6.png)

**Remark 7**

*有人可能会担心纵向排序定义不够robust，例如条目2中的定义，假设c1,c2到路口距离分别是20m,20.1m。这不是一个问题，因为这个定义只有在两辆车之间有一个安全的纵向距离时才有效地使用，在这种情况下，两辆车之间的顺序将是显而易见的此外，这完全类似于两辆车并排行驶在多车道高速公路上时排序的非鲁棒性。*

**Definition 17(Longitudinal Safe Distance for Two Routes of Different Geometry)**

当满足下面一条时，纵向是安全的：

1. 如果对所有$i \in {1,2}$，$r_i$都没有优先级，如果$c_i$将在$\rho$秒内加速，加速度为$a_{max,accel}$，接着通过刹车(加速度为$a_{min,brake}$直到纵向速度为0,在此期间，$c_i$将保持在另一条路线之外
2. 否则，如果$c_1$在$c_2$的前面，如果$c_1$采取刹车且制动加速度为$a_{max,brake}$直到纵向速度为0，且$c_2$在$\rho$秒内加速，且加速度最多为$a_{max,accel}$,接着开始刹车且刹车加速度至少为$a_{min,brake}$直到0速度，c1仍然在c2前面
3. 考虑$p \in r_1 \cap r_2$，$p$点在$r_i$上的横向位置分别是在区间$[x_{i,min},x_{i,max}]$ ，令$[t_{i,min},t_{i,max}]$ 表示$c_i$在$r_i$到达纵向位置p的所有可能时间。如果$c_i$在一开始的$\rho$秒内施加的纵向加速度范围是在$[-a_{max,brake},a_{max,accel}]$，随后进行制动，制动加速度范围在$[a_{min,brake},a_{max,brake}]$ ,直到速度为0，接着，两车到达p点的时间$[t_{1,min},t_{1,max}]$与$[t_{2,min},t_{2,max}]$之间无重叠部分则认为两车是有一个安全的纵向距离。

![RSS_figure7](E:\PnC\pnc_research\elements\RSS_figure7.png)

纵向危险时间和危险阈值时间的定义同定义3，但纵向安全距离按定义17。

**Definition 18(Longitudinal Proper Response for Routes of Different Geometry)**

假设在t时刻对于两车来说都是危险的，纵向的合适响应取决于在危险阈值之前的情况 ：

- 根据item(1)纵向距离是安全的，那么某辆车在优先级高的路线上，那么可以正常驾驶，如果$t-t_0 \geq \rho$，另一辆就必须采取制动，且加速度不低于$a_{min,brake}$
- 否则如果，根据item(2)纵向距离是安全的，那么c1可以正常驾驶。且如果$t-t_0 \geq \rho$， c2必须采取制动至少为$a_{min,brake}$
- 否则如果，根据item(3)纵向距离是安全的，在$t-t_0 \leq \rho$，两车都可正常驾驶，否则，两车应该在横向和纵向上都进行制动，且制动加速度不低于$a^{lat}_{min,brake},a_{min,brake}$

**Remark 8(No contradicions and star-shape calculations Revisited)**

适当响应的最新定义是关于在两条路线上行驶的两辆汽车。 和之前一样，我们需要考虑我们的车相对于其他车的适当反应。也就是说，这里我们再次采用星形计算。由于相对于其他每辆车的适当响应被转化为相对于我们路线的横向和纵向制动约束，因此相对于不同agent的适当响应之间不存在冲突。例如，在图5左侧所示的情况下，对于红色汽车的正确响应是纵向制动，因此它与对于黄色汽车的横向制动的正确响应并不矛盾。因此，很容易证明我们的归纳证明仍然成立。最后，请注意，在某些情况下，另一个agent使用的路径是未知的，如图8。在这种情况下，每个agent都应该遵守通过检查所有可能性得到的适当响应。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          

![RSS_figure8](E:\PnC\pnc_research\elements\RSS_figure8.png)

#### 3.7.1 Traffic Lights

接下来讨论的是带红绿灯的路口。有人可能会认为交通灯场景的简单规则是“如果一辆车的路线是绿灯，而另一辆车的路线是红灯，那么责任就在那条路线上有红灯的那辆车上”。然而，这不是正确的规则。例如，考虑图9所示的场景。即使黄车的路线有绿灯，我们也不期望它忽略已经在十字路口的红车。正确的规则是绿灯优先于红灯优先。因此，我们从交通信号灯到我们之前描述的路线优先级概念得到了明显的简化。以上论述是对通行权规则的一种常识性的形式主义给予，而非采取。

![RSS_figure9](E:\PnC\pnc_research\elements\RSS_figure9.png)

#### 3.7.2 Unstructured Road

考虑一些非结构化道路，如图10.

![RSS_figure10](E:\PnC\pnc_research\elements\RSS_figure10.png)

如图10a,环岛形状的道路，在这里，虽然道路区域到车道的划分没有很好地定义，但道路到多条路线的划分(每条路线都有清晰的几何形状)是很好的定义。由于我们对适当响应的定义只依赖于路线的几何形状，所以它们适用于这样的场景。接下来，考虑根本没有路由几何的场景，如图10(巨型停车场)。不像结构化的情况，我们把横向和纵向分开，这里我们需要二维轨迹。

**Definition 19(Trajectories)**

*考虑车c驾驶在某条道路上，c的未来行驶轨迹由函数$\tau$定义：$\mathbb{R}_+ \rightarrow \mathbb{R}^2$，$\tau(t)$是c的位置关于时间的函数。在t时刻的轨迹正切向量$\tau'(t)$是$\tau$关于t的Jacobian矩阵。记$t_s(\tau)=sup\{t:\forall t_1 \in[0,t),\left \| \tau'(t)>0\right\|\}$。$t_s$是车辆第一次到达完全停止的时间，如果不存在这样的t，则设$t_s(\tau) = \infty$*

危险的情况将取决于两个轨道之间发生碰撞的可能性。这是正式表达如下：

**Definition 20(Trajectory Collision)**

令$\tau_1,\tau_2$表示c1,c2的未来轨迹，且相应的停车时间为$t_1 = t_s(\tau_1),t_2 = t_s(\tau)$，给定参数$\epsilon,\theta$,那么如果以下一条成立的话，就认为$\tau_1,\tau_2$不会发生碰撞。

1. 对任意$t \in [0,max(t_1,t_2)]$,都有$\left \|\tau_1(t) - \tau_2(t) \right \| > \epsilon$ 
2. 对于任意$t \in [0,t_1]$,我们有$\left \|\tau_1(t) - \tau_2(t) \right \| > \epsilon$ ，以及两个向量夹角的绝对值$(\tau_2(t_1) - \tau_2(t_1))$和$\tau'_2(t_1)$最多为$\theta$.

给定c1一组轨迹，记为$\mathcal{T}_1$,c2的一组轨迹记为$\mathcal{T}_2$，如果对每一个$(\tau_1,\tau_2)\in \mathcal{T}_1 \times \mathcal{T}_2$，都有$\tau_1 \cap \tau_2 = \empty$，那么认为$\mathcal{T}_1 \cap \mathcal{T}_2 = \empty$

第一个项目指出，两辆车将远离对方，直到他们都完全停止。第二项规定车辆将远离彼此，直到第一辆车完全停止，此时，第二辆车的速度矢量指向远离第一辆车。

注意，我们定义的碰撞操作符是不可交换的,试想一下，两辆车同方向驾驶在一个非常巨大的圆上，且c1从后方接近c2，考虑c1的轨迹$\tau_1$是剧烈的进行刹车，而c2的轨迹$\tau_2$则以正常速度行驶，显然有$\tau_1 \cap \tau_2 = \empty$而$\tau_2 \cap \tau_1 \neq \empty$.

我们继续使用一种通用的方法，它依赖于“刹车”和“继续前进”行为的抽象概念。在结构化情况下，这些行为的含义是根据允许的横向和纵向加速度间隔来定义的。稍后，我们将在非结构化情况下指定这些行为的含义，但现在，我们在依赖抽象概念的情况下继续进行定义。

**Definition 21(Possible Trajectories due to Braking and Normal Driving)**

*假设有一辆车c在路上行驶。关于汽车的行为给定一组约束C，我们记$\mathcal{T}(C,c)$是车辆c在给定约束C下，所有可能的未来轨迹。特别有趣的是$\mathcal{T}(C_b,c),\mathcal{T}(C_f,c)$表示由于制动行为约束和继续前进行为约束的未来轨迹。*

我们现在可以完善安全距离、危险情况、危险阈值时间、适当反应和责任的概念。

**Definition 22（Safe Distance,Dangerous Situation,Danger Thershold time,and Proper Response ,in Unstructured Roads**

*如果下面一项成立的话，在非结构化道路上c0,c1之间的距离就是安全的：*

1. *For some $i \in {1,0}$,we have $\mathcal{T}(C_b,c_i) \cap \mathcal{T}(C_f,c_{1-i}) = \empty$  and $\mathcal{T}(C_b,c_{1-i}) \cap \mathcal{T}(C_f,c_i) \neq \empty$.*
2. *$\mathcal{T}(C_b,c_0)  \cap \mathcal{C_b*,c_1} = \empty$

*令$t_b$表示危险阈值时间，那么该时间下，车$c_j$的合适的反应是：*

- *如果两车都完全停住了，接着$c_j$可以朝着远离$c_{1-j}$的方向行驶(这意味着$c_j$与$c_{1-j}$之间的速度方向夹角最大值为$\theta$)*
- *或者，如果在item(1)中，$t_b$是安全的，并且有$j=1-i$，接着$c_j$应继续在约束$C_f$下保持向前行驶的行为，只要$c_{1-j}$没有完全停止下来，之后两车应该都完全停止下来。*
- *否则，否则，适当的响应是制动，即遵守约束$C_b$*。

最后，为了使这种通用方法具体化，我们需要确定制动约束$C_b$和继续向前行为约束$C_f$.回想一下，一个清晰的结构给了我们两个主要的东西。首先，车辆可以预测其他车辆会做什么(其他车辆应该在自己的路线上行驶，并以有限的速率改变横向/纵向速度)。其次，当车辆处于危险时刻时，适当的响应是根据路线的几何形状来定义的(横向和纵向的“刹车”)。很重要的一点是，正确的反应不是在与我们处于非安全距离的另一辆车之间定义的，因为如果是这样的话，当一辆车与另一辆车处于非安全距离时，我们可能会发生冲突。因此，在为非结构化场景设计定义时，我们必须确保上述两个属性仍然有效。

我们采用的方法依赖于车辆的基本运动学模型。对于速度，我们采用与纵向速度相同的方法(限定允许的加速度范围)。对于横向运动，观察到当车辆保持恒定的方向盘角度和恒定的速度时，它将(近似地)绕圆周运动。换句话说，汽车的航向角将以恒定的速率变化，这被称为汽车的偏航率。定义车辆速度为$v(t)$,航向角$h(t)$,以及航向角速率$h'(t)$,当$h'(t)$和$v(t)$恒定时，车辆将行驶在半径为$v(t)/h'(t)$的圆上。记为$r(t) = v(t)/h'(t)$.我们将对正常驾驶做两个约束。第一个是半径的倒数以有界的速率变化，第二个时$h'(t)$也是有界的。期望的刹车行为将会在响应时间内用一种有界的方式改变$h'(t)$和$1/r(t)$,并开始在圆上行驶(或者至少与圆的距离不超过$\epsilon/2$)。这种行为在整个响应时间内，形成以最多$a^{lat}_{max,accel}$的加速度类比，接着开始减速直到横向速度为0.

为了有效地计算安全距离，我们构造了超集$\mathcal{T}(C_b,c)$如下所述,W.l.o.g(不失一般性)：令危险阈值时间$t=0$，并假设在危险阈值时刻，c的航向为零。通过约束$|h'(t)|\leq h'_{max}$，我们直到$|h(\rho)|\leq \rho h'_{max}$ ，另外，半径的倒数在时间$\rho$必须满足：
$$
\frac{1}{r(0)}-\rho r^{-1'}_{max}\leq \frac{1}{r(\rho)}\leq \frac{1}{r(0)}+\rho r^{-1'}_{max}
$$
其中，$r(0)=v(0)/h'(0)$。总之，我们定义超集$\mathcal{T}(C_b,c)$里面所有的轨迹的初始角度范围在$[-\rho h'_{max},\rho h'_{max}]$,根据上式，轨迹始终实在一个圆上，圆上的纵向速度和结构情况一样。对于继续向前的轨迹，即使在相应时间之后，我们采用同样的操作运行纵向加速度为$[-a_{max,brake},a_{max,accel}]$，如图11所示。

![RSS_figure11](E:\PnC\pnc_research\elements\RSS_figure11.png)

最后，观察这些适当的响应是否满足结构化场景中适当响应的上述两个属性：在发生紧急情况时，可以约束其他车辆的未来位置，并且即使我们处于危险的情况下，也可以应用相同的适当响应。

### 3.8 Pedestrians

在某些情况下，行人的路线是明确的(例如斑马线或快车道上的人行道)。在其他情况下，如典型的住宅街道，我们遵循我们在非结构化道路上采取的方法，除了不同于车辆通常绕圈行驶，对于行人，我们限制了方向的变化$|h'(t)|$，并假设在紧急情况下，在响应时间之后，行人将继续走直线。如果行人是站立的，我们将其分配给从他当前位置出发的所有可能的线。优先级是根据道路类型设置的，也可能是根据交通灯设置的。例如，在一条典型的住宅街道上，行人优先于车辆，因此车辆必须对行人让步并保持谨慎。相反，在有人行道的道路上，车辆不应该担心人行道上的行人会突然跑到马路上，此处车辆具有优先权。另一个例子是有交通灯的斑马线，根据交通灯动态设置优先级。当然，优先权不是给予的，因此即使行人没有优先权，如果他们在安全距离进入道路，汽车也必须刹车让他们通过。让我们用一些例子来说明这个观点。第一个例子是站在住宅道路上的行人。行人被分配到从其当前位置发出的射线所获得的所有路线上。她的纵向安全距离关于每条虚拟路线都很短。例如，设置延迟为500ms,最大加速度和最大制动为$2m/s^2$,其安全纵向距离为50cm。由此可见，车辆必须处于运动状态，这样，如果它将施加适当的响应(加速度ρ秒，然后制动),将会保持在以行人为中心半径为50cm的球体之外。

第二个例子是一个行人站在斑马线前面的人行道上，行人有红灯，一辆车在绿灯时接近斑马线。在这里，车辆路线具有优先权，因此车辆可以假设行人将留在人行道上。 如果行人进入道路，而车辆是在一个安全的纵向距离(w.r.t.车辆的路线)，那么车辆必须刹车(“路权是给予的，而不是采取”)。但是，如果行人在车辆未处于安全纵向距离时进入道路，导致车辆撞到行人，则车辆不承担责任。因此，在这种情况下，车辆可以以正常速度行驶，而不必担心行人。

第三个例子是在住宅道路上以每小时10公里(≈2:7m=s)的速度奔跑的行人。行人可能的未来轨迹形成一个等腰三角形。使用与第一个例子相同的参数，这个三角形的高度大约是15m。由此可见，汽车不应在小于15米的距离内进入行人路线。但是，如果汽车进入行人路线的距离大于15m，而行人没有停车而撞到汽车，则责任由行人承担。

### 3.9 Cautiousness with respect to Occlusion

当人们因为事故而受到指责时，最常见的反应是“但我看不到他”，很多时候，这是真的。人类的感知能力是有限的，有时是因为无意识地决定将注意力集中在道路的不同部分，有时是因为粗心大意，有时是因为身体上的限制——不可能看到一个藏在停着的汽车后面的小孩。虽然先进的自动传感系统从不粗心，并具有360度的道路视图，但由于物理阻塞或传感器检测范围，它们仍然可能受到有限的传感。以下是一些例子:

**Example 1** 十字路口:一个建筑物或栅栏挡住从不同路线进入该路口的车辆的路口,如图12

**Example 2**  当在高速公路上变道时，探测后方车辆的视野范围有限，如图13

**Example 3**  一个可能被堵在停着的车后面的孩子。

**Example 4**   前面的障碍物被我们前面的汽车挡住了，如图14

![RSS_figure12](E:\PnC\pnc_research\elements\RSS_figure12.png)

![RSS_figure13](E:\PnC\pnc_research\elements\RSS_figure13.png)

![RSS_figure14](E:\PnC\pnc_research\elements\RSS_figure14.png)

上面的例子表明，我们可能在不知情的情况下(由于遮挡)处于危险的境地，因此我们不会做出正确的反应。当一个人类司机说“但是我看不见他”时，反驳的理由通常是“好吧，你应该更小心点”。类似地，我们应该将“小心”的含义形式化。

“谨慎”的极端形式是假设最坏的情况。也就是说，我们应该假设世界上每一个被遮挡的位置都被一辆速度可能最差的车辆占据。不幸的是，如果没有对被遮挡物体的额外假设，这将导致过度防御，非自然驾驶。要了解这一点，请考虑静态对象遮挡的最简单情况，如例1所示，如图12所示。在黄色汽车所在的任何位置，都可能有一辆被建筑物遮挡的红色汽车。当黄色汽车进入红色汽车的走廊时，存在一个足够高的速度给红色汽车，这将被认为是不安全的切入。这导致黄色汽车无法并入主干道。当然，限制这种做法是不合理的。

这促使我们将驾驶员可能对其他道路使用者的行为做出的几个额外的“合理假设”形式化。在本节中，我们含蓄地定义了“不合理的情况”，并允许车辆做出“合理的假设”，即这种情况不会发生。例如，我们对自身纵向距离的基本定义假设另一辆车的制动强度不会超过$a_{max,brake}$，通过这种假设，我们含蓄地说，当车辆的刹车强度大于$a_{max,brake}$时，这种情况是不合理的，并且我们运行这样情况发生，也不必过于担心。当然，我们也要求车辆不要造成“不合理的情况”，例如，自车的刹车强度绝对不能超过$a_{max,brake}$。为了解决闭塞，我们遵循完全相同的理性，通过定义不合理的情况，并允许车辆假设它们不会发生。所以，车辆应该做最坏的打算，除了这些不合理的情况。正如我们将看到的，我们还需要车辆要考虑到其他车辆可能没有完全观察到它，因此要小心，不要造成不合理的情况。为了形式化上述，作为一个初步的陈述，很明显，一旦一个对象被观察到，我们应该按照常规的适当反应规则行事。我们用曝光时间来表示这个时间点。

**Definition 23(Exposure Time)**

*物体的曝光时间是我们第一次看到它的时间(意思是没有任何东西可以阻挡从物体到自车的视线)。*

我们继续定义两种不合理的情况。第一种是处理由于车辆超速行驶造成的不合理情况。再次考虑静态物体的遮挡，如例1所示，如图12所示。如上所述，如果黄色汽车不小心并入道路，可能是暴露时间在危险阈值时间之后-即，在不知情的情况下进行了危险的插队。然而，如果对被遮挡的汽车(红色汽车)的速度有一个限制，黄色汽车将能够以足够慢的速度接近合并点，以确保它不会进入一个危险的情况，两车的速度最多为$v_{limit}$。引出以下定义：

**Definition 24(Unreasonable Situation due to Unreasonable Speed)**

*假设有两辆车分别在$r_1,r_2$上行驶，但是由于存在遮挡，在曝光时间t之前都无法看到对方。假设t时刻为危险时刻，并令$t_b$为相应的blame time.对于$i\in{1,2}$，令$v^{lat}_i,v^{long}_i$从$t_b$到$t$的平均横向或纵向速度。有参数$v^{lat,limit,low}_i,v^{lat,limit,high},v^{long,limit,low}_i,v^{long,limit,high}$，如果$v^{lat}_i \notin [v^{lat,limit,low}_i,v^{lat,limit,high}]$或者$v^{long}_i \notin [v^{long,limit,low}_i,v^{long,limit,high}]$,那么我们认为这种情况时不可知的。*

这些参数与每个ci在地图上的位置、优先级规则以及可能的其他场景结构和条件相关联。

例如，在图12中，红色和黄色的汽车都可能假设另一辆汽车将足够慢地接近十字路口，其中速度的上限取决于两条路线之间的优先级。这将允许黄色汽车安全地并入主要道路，就像人类司机一样。

在确定速度的限制条件时应包括的几个因素如下。首先，该定义考虑了优先级规则，具有优先级的路径的最大速度上限越高。其次，该定义还考虑了不同的场景结构规则。比较有意思的是示例2中给出的情况，其危险阈值时间如图13所示。红色车记为$c_2$，从黄色车$c_2$角度看是被遮挡的。由于$c_2$的横向速度，横向距离已经有一段时间不安全了。然而，纵向距离在blame time变得不安全，$c_0$由于道路结构原因导致没有优先级。然而，在闭塞时间内，$c_2$执行的“纵向安全切入”，根据常识不会被认为是“安全的”，因为c2不能确保被看到。因此，假设被遮挡物体的横向速度有一个界限是合理的。使用这个假设，当通过停靠的公共汽车附近时，c0不必减速太多，因为它可以假设没有执行插队。

在例3中，被遮挡的行人可能会跳到道路上，处理方法与此相同，汽车可以假设被遮挡的行人不会插队。虽然明确地处理静态遮挡，但合理的速度假设也适用于移动遮挡。例如，如果图13中的公共汽车缓慢移动，则$c_0$仍然可以假设$c_1$的横向速度较低。

第二种不合理情况是由其他agent的不当行为引起的,如例4，黄车与红车之间保持着安全距离，但是蓝车处于完全停车的状态。在最后时刻，红车选择紧急变道来避开蓝车，如果黄车也可以紧急变道避免撞上蓝车，也可以避免事故，然而，黄车无法避免事故也是有可能的，因此相邻车道可能有其他车辆，并从后方撞上蓝车。而这次，事故责任在于黄车。

为了应对这种情况，第一个尝试可能是要求$c_0$总是假设最坏的情况,即总是可能有一辆停在$c_1$前面。不幸的是，这样假设的话，是不能在高速公路上正常驾驶，为了说明采用这种假设所导致的驾驶的防御性，让我们考虑$c_0$的制动距离，这与停车时的安全距离大致相同。假设在高速上，$c_0$的车速为$30m/s$，且最大刹车加速度为$10m/s^2$，那么最短刹停距离为$d=v^2/2a = 45$。这意味着与c1保持小于≈45m的距离(对应于1.5秒的车速)是不安全的。很明显，在高速公路上行驶时，与前车保持的距离甚至更小。显然，普通的高速公路驾驶不会避免与前车保持更少的距离。

仔细检查所给的例子，可以发现以下现象：如果c1与c2保持安全的(纵向)距离，就不会有问题;c1总能在撞上c2之前刹车。对于$c_0$，如果对$c_1$有正确的反应，是能够在撞上$c_2$前停下来，也更不会撞上$c_2$。这激发了我们对第二类不合理情景的定义。

**Definition 25(Unresonable Situation due to Improper Behavior)**

*在时间t，c，c1之间的情景是由于不当行为引起的不合理情况,如果总是遵守适当的响应规则是不可能达到的，也就是说，在时间范围$(-\infty,t)$内不存在以下状态序列：*

- *物理上可能的(在某种意义上，它遵守合理的速度和加速度界限)*
- *c或者c'不包含任何的不当响应*

图14左侧所示的红色和蓝色汽车之间的情况就是由于不当行为而导致的不合理情况的一个例子。在这种情况下，红色和蓝色汽车处于危险的境地，但如果他们都坚持正确的反应，就不可能达到这种境地。通过允许黄色汽车假设不会发生由于不当行为导致的不合理情况，当它跟随红色汽车并可能担心在红色汽车前面的非安全距离处有一辆汽车c2时，它可以假设它的速度相当大——否则，这一定意味着红色汽车没有对c2做出适当的响应。

**Definition 26(Proper Response in the presence of Occlusions  )**

*车辆必须对它所观察到的所有道路agent作出适当的反应。它还必须对被遮挡的物体做出适当的响应，通过假设在任何遮挡的位置可能有一个以任何可能的速度被遮挡的物体，除非这会产生定义24和定义25中定义的不合理情况。最后，车辆不得造成不合理的情况(如定义24所定义)。*

### 3.10 Responsibility

我们已经定义了对危险局势作出适当反应的概念。在事故发生之前，情况必须是危险的。如果agent没有遵守适当的响应约束，我们就说agent对事故负有责任。不难看出，如果没有闭塞，如果两个agent发生碰撞，那么一定是其中至少一个agent没有遵守适当的响应约束，并且该agent应对事故负责。然而，当有闭塞时，可能会发生没有明确责任的事故。考虑图14的例子。一方面，允许黄色汽车假设，如果红色汽车前面有一辆车c2，那么红色汽车对它施加了适当的响应。所以，黄色的车不对事故负责。的确，红色汽车对蓝色汽车没有做出正确的反应，但红色汽车根本没有参与事故，因此我们不清楚是否可以将黄色汽车和蓝色汽车之间的事故归咎于红色汽车。在下一节中，我们将证明如果所有代理都遵守适当的响应规则，则不会发生事故。

### 3.11 Utopia is Possible

在引理5中，我们已经证明，如果道路上所有的汽车都遵守基本的适当响应规则，那么就不会发生碰撞。然而，在前一小节中，我们已经表明，智能体可以对闭塞区域发生的事情做出一些合理的假设，因此，两个智能体之间可能发生事故，其中没有一个是直接负责的。我们现在证明，即使在考虑闭塞的情况下，如果所有的agent都遵守定义26中给出的适当的响应规则，那么就不会发生事故。

证明技术依赖于下面的引理，该引理表明，如果所有agent都遵守定义26中给出的适当响应规则，那么它们实际上也遵守基本的适当响应规则。

**Lemma 6**如果所有道路agent都遵守定义26所述的适当反应规则，他们也遵守基本的适当反应规则。换句话说，每个agent的行为就好像它在观察所有其他agent一样。

**推论2**(乌托邦是可能的)如果所有道路代理都遵守定义26中给出的适当响应规则，则不会发生碰撞。



## 4. RSS resouce code analyse

### 4.1 成员变量

 **自定义的结构体**

```C
enum LongitudinalDirection {Front = 0,rear};
enum LateralDirection {Left = 0,right = 0};
enum class LongitudinalViolateType {legal = 0,TooFast,TooSlow};

struct RssConfig{
    decimal_t response_time = 0.1;
    decimal_t longitudinal_acc_max = 2.0;
    decimal_t longitudinal_brake_min = 4.0;
    decimal_t longitudinal_brake_max = 5.0;
    decimal_t lateral_acc_max = 1.0;
    decimal_t later_brake_min = 1.0;
    decimal_t lateral_brake_max = 1.0;
    decimal_t lateral_miu = 0.5;
    RssConfig() {}
    RssConfig(const decimal_t _response_time,
              const decimal_t _longitudinal_acc_max,
              const decimal_t _longitudinal_brake_min,
              const decimal_t _longitudinal_brake_max,
              const decimal_t _lateral_acc_max,
              const decimal_t _lateral_brake_min,
              const decimal_t _lateral_brake_max, const decimal_t _lateral_miu)
        : response_time(_response_time),
          longitudinal_acc_max(_longitudinal_acc_max),
          longitudinal_brake_min(_longitudinal_brake_min),
          longitudinal_brake_max(_longitudinal_brake_max),
          lateral_acc_max(_lateral_acc_max),
          lateral_brake_min(_lateral_brake_min),
          lateral_brake_max(_lateral_brake_max),
          lateral_miu(_lateral_miu) {}
}
```

### 4.2 功能函数

### 4.2.1 CalculateSafeLongitudinalDistance

**Input**

- ego_vel:自车速度
- other_vel:他车速度
- LongitudinalDirection direction:纵向方向
- RssConfig& config：rss参数

**Output**

- distance: 纵向安全距离

**Implement**

该过程主要由3.3节提供的公式进行计算，一个计算同向安全距离，一个计算对向安全距离。



### 4.2.2 CalculateSafeLateralDistance

**Input**

- ego_vel:自车速度
- other_vel:他车速度
- LongitudinalDirection direction:纵向方向
- RssConfig& config：rss参数

**Output**

- distance: 横向安全距离

**Implement**

1. 计算自车反应时间后横向速度

2. 计算他车反应施加后横向速度

3. 自车active状态下刹车距离

4. 自车passive状态下刹车距离

5. 他车active状态下刹车距离

6. 他车passive状态下刹车距离

7. 如果自车从右侧靠近他车

   1. ```C 
      if(ego_vel >= 0.0 && other_vel >= 0.0)
          // -------------------------------
          // ego    ^^^^^^^^
          // -------------------------------
          // other  ^^^^^^^^
          // -------------------------------
          ret = other_passive_brake_distance - ego_active_brake_distance
      ```

   2. ```C
      if(ego_vel >= 0.0 && other_vel < 0.0)
          // -------------------------------
          // ego    ^^^^^^^^
          // -------------------------------
          // other  vvvvvvvv
          // -------------------------------
          ret = 0
      ```

   3. ```c
      if(ego_vel < 0.0 && other_vel < 0.0)
      	// -------------------------------
          // ego    vvvvvvvv
          // -------------------------------
          // other  vvvvvvvv
          // -------------------------------
          ret = ego_passive_brake_distance - other_active_brake_distance;
      ```

   4. ```C
      if(ego_vel < 0.0 && other_vel >= 0.0)
      	// -------------------------------
          // ego    vvvvvvvv
          // -------------------------------
          // other  ^^^^^^^^
          // -------------------------------
          ret = ego_passive_brake_distance + other_passive_brake_distance;
      ```

8. 如果自车从左侧靠近他车

   1. ```C 
      if(ego_vel >= 0.0 && other_vel >= 0.0)
          // -------------------------------
          // ego    ^^^^^^^^
          // -------------------------------
          // other  ^^^^^^^^
          // -------------------------------
          ret = ego_passive_brake_distance - other_active_brake_distance;
      ```

   2. ```C
      if(ego_vel >= 0.0 && other_vel < 0.0)
          // -------------------------------
          // ego    vvvvvvvv
          // -------------------------------
          // other  ^^^^^^^^
          // -------------------------------
          ret = ego_passive_brake_distance + other_passive_brake_distance;
      ```

   3. ```c
      if(ego_vel < 0.0 && other_vel < 0.0)
      	// -------------------------------
          // ego    vvvvvvvv
          // -------------------------------
          // other  vvvvvvvv
          // -------------------------------
          ret = other_passive_brake_distance - ego_active_brake_distance;
      ```

   4. ```C
      if(ego_vel < 0.0 && other_vel >= 0.0)
      	// -------------------------------
          // ego    ^^^^^^^^
          // -------------------------------
          // other  vvvvvvvv
          // -------------------------------
          ret = 0
      ```

   

### 4.2.3 CalculateRssSafeDistances

​	分别计算横向和纵向RSS safe distance

### 4.2.4 CalculateSafeLongitudinalVelocity

**Input**

- other_vel
- LongitudinalDirection direction
- lon_distance_abs
- config

**Output**

- ego_vel_low
- ego_vel_upp

**Implement**

```Cpp
decimal_t other_vel_abs = fabs(other_vel);
decimal_t other_vel_at_response_time = other_vel_abs + config.longitudinal_acc_max * config.response_time;
decimal_t other_distance_dirven;
//如果自车的方向朝前
if(direction == Front){
    //ego ----->(lon_distance) other ---->
    //other hard brake
    other_distance_dirven = (other_vel_abs * 	other_vel_abs)/(2*config.longitudinal_brake_max);
    //ego has vel upp
    decimal_t a = 1.0/(2.0 * config.longitudinal_brake_min);
    decimal_t b = config.response_time + 
        		  (config.longitudinal_acc_max * config.response_time / 			
                   config.longitudinal_brake_min);
    decimal_t c = 0.5 * (config.longitudinal_acc_max + 
                  pow(config.longitudinal_acc_max, 2) / config.longitudinal_brake_min) 					  *pow(config.response_time, 2) -
        		  other_distance_driven - lon_distance_abs;
    *ego_vel_upp = (-b + sqrt(pow(b,2) - 4 * a *c ))/(2 * a);
    *ego_vel_low = 0.0;
}
```

$d_1$为自车到前车的安全距离，$d_2$为前车最大制动下的刹车距离

自车在当前车速下以最大制动刹停的距离加上反应时间内移动的距离加上最坏情况下，自车处于加速状态下的移动距离应不超过$d_1,d_2$

如两车同方向即：
$$
\frac{v^2}{2a_{a,max}}+(\rho + \frac{a_{a,max}}{a_{b,min}}\rho)v+\frac{1}{2}(a_{a,max} + \frac{a^2_{a,max}}{a_{b,min}})\rho ^2 = d_1 + d_2
$$
如两车对向
$$
\frac{v^2}{2a_{a,max}}+(\rho + \frac{a_{a,max}}{a_{b,min}}\rho)v+\frac{1}{2}(a_{a,max} + \frac{a^2_{a,max}}{a_{b,min}})\rho ^2 = d_1 - d_2
$$

### 4.2.5 RSS Check Ⅰ

**Input**

- FrenetState ego_fs
- FrenetState other_fs
- RssConfig config

**Output**

- bool is_safe



**Implement**

1. 确定自车与他车的相对关系
2. 计算RSS下横向和纵向安全距离
3. 判断实际横向与纵向距离与RSS 安全距离的大小并给出是否安全

### 4.2.5 RSS Check Ⅱ

相比于Ⅰ，多了给出RSS的参考速度
